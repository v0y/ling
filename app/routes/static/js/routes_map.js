// Generated by CoffeeScript 1.6.2
(function() {
  var bindToFileInputChange, fileUploadChangeState, fillFormFields, handleMapOnFileUploadSuccess, main, sendFile, validateFileExtansion;

  bindToFileInputChange = function(mapHandler) {
    var $form;

    $form = $('#gpx-file-input-form');
    return $form.find("input:file").change(function() {
      return sendFile($form, mapHandler);
    });
  };

  sendFile = function($form, mapHandler) {
    var $inputField, csrfToken, fd, xhr;

    $inputField = $form.find("input:file");
    if (validateFileExtansion($inputField)) {
      xhr = new XMLHttpRequest();
      xhr.open("POST", $form.data('url'));
      csrfToken = $.cookie('csrftoken');
      if (csrfToken) {
        xhr.setRequestHeader("X-CSRFToken", csrfToken);
      }
      xhr.onreadystatechange = function() {
        return fileUploadChangeState(xhr, mapHandler);
      };
      fd = new FormData($form.get(0));
      return xhr.send(fd);
    }
  };

  validateFileExtansion = function($inputField) {
    var extention;

    extention = $inputField.val().split(".").pop().toLowerCase();
    if (extention === 'gpx') {
      return true;
    } else {
      alert("To nie jest właściwy rodzaj pliku - wybierz plik .gpx");
      return false;
    }
  };

  fileUploadChangeState = function(xhr, mapHandler) {
    var response, routeId, routes;

    if (xhr.readyState === 4 && xhr.status === 200) {
      response = JSON.parse(xhr.responseText);
      routeId = response['id'];
      routes = JSON.parse(response['tracks']);
      handleMapOnFileUploadSuccess(mapHandler, routes);
      return fillFormFields(routeId, mapHandler);
    } else if (xhr.readyState === 4) {
      return alert("Something went wrong. Error" + xhr.status);
    }
  };

  handleMapOnFileUploadSuccess = function(mapHandler, routes) {
    if (!mapHandler.map) {
      mapHandler.initializeMap();
    }
    return mapHandler.singleNewRoute(routes);
  };

  fillFormFields = function(routeId, mapHandler) {
    $('#id_route_id').val(routeId);
    $('#id_distance').val(mapHandler.distance);
    $('#id_datetime_start').val(mapHandler.startTime.format('DD-MM-YYYY'));
    $('#id_time_start').val(mapHandler.startTime.format('HH:mm'));
    $('#id_duration_hours').val(mapHandler.duration.hours());
    $('#id_duration_mins').val(mapHandler.duration.minutes());
    return $('#id_duration_secs').val(mapHandler.duration.seconds());
  };

  main = function() {
    var mapHandler;

    mapHandler = new RoutesMapHandler();
    return bindToFileInputChange(mapHandler);
  };

  $(function() {
    return main();
  });

}).call(this);
